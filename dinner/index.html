<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä»Šå¤©åƒä»€ä¹ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #F5F3FF;
            --card-bg: #FFFFFF;
            --primary: #7C3AED;
            --text-main: #1E1B4B;
            --text-sub: #6B7280;
            --shadow: 0 8px 30px rgba(0,0,0,0.06);
            --radius: 20px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- 3D å›¾ç‰‡åŠ¨ç”»ç‰¹æ•ˆ --- */
        .img-3d {
            filter: drop-shadow(0px 10px 15px rgba(124, 58, 237, 0.15));
            transform: perspective(500px) rotateX(5deg) scale(1);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: block;
            object-fit: contain;
        }
        /* æŒ‰å‹æ—¶çš„å¾®åŠ¨æ•ˆ */
        .active-card:active .img-3d { transform: scale(0.9) rotateX(0deg); }

        .step-container {
            position: absolute; inset: 0;
            padding: 20px;
            padding-top: calc(env(safe-area-inset-top) + 80px);
            padding-bottom: 100px;
            display: flex; flex-direction: column;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0; transform: translateX(100px) scale(0.95);
            pointer-events: none;
        }
        .step-container.active { opacity: 1; transform: translateX(0) scale(1); pointer-events: all; }
        .step-container.prev { opacity: 0; transform: translateX(-100px) scale(0.95); pointer-events: none; }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 20px 40px -10px rgba(124, 58, 237, 0.1);
            border-radius: 2.5rem;
        }

        .floating-dock {
            position: fixed; bottom: 30px; left: 20px; right: 20px;
            background: #1E1B4B; border-radius: 30px; padding: 10px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 15px 30px rgba(30, 27, 75, 0.25);
            z-index: 50; padding-bottom: calc(10px + env(safe-area-inset-bottom));
            transition: transform 0.3s;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="antialiased">

    <!-- ç»Ÿä¸€é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="absolute top-0 left-0 w-full p-6 flex justify-between items-center z-50 pointer-events-none pt-[calc(env(safe-area-inset-top)+20px)]">
        <div id="nav-btn" class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm cursor-pointer pointer-events-auto hover:bg-gray-50 active:scale-90 transition text-xl" onclick="handleNavClick()">
            ğŸ 
        </div>
        <div class="w-10 h-10 rounded-full overflow-hidden border-2 border-white shadow-sm pointer-events-auto bg-purple-100">
            <img src="https://raw.githubusercontent.com/Tarikul-Islam-Anik/Microsoft-3D-Fluent-Emojis/master/Emojis/People/Person/3D/person_3d.png" class="w-full h-full object-cover">
        </div>
    </div>

    <!-- Main App Container -->
    <div class="relative w-full h-full max-w-md mx-auto">

        <!-- STEP 1: ç”¨é¤æƒ…æ™¯ -->
        <div class="step-container active" id="step-1">
            <div class="mt-2 mb-6">
                <h2 class="text-gray-400 text-sm font-semibold uppercase tracking-wider mb-1">Dinner Decider</h2>
                <h1 class="text-4xl font-bold text-[#1E1B4B]">Who is<br>eating today?</h1>
            </div>

            <div class="flex-1 overflow-y-auto no-scrollbar space-y-5">
                <!-- æ›¿æ¢ä¸ºå›¾ç‰‡ -->
                <div onclick="selectContext('shared')" class="active-card glass-card p-6 flex items-center gap-5 cursor-pointer transition transform active:scale-95">
                    <div class="w-20 h-20 bg-orange-100 rounded-3xl flex items-center justify-center overflow-hidden">
                        <img src="" id="img-shared" class="img-3d w-16">
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-900">äºŒäººé£Ÿ</h3>
                        <p class="text-sm text-gray-500 mt-1">å£å‘³æŠ˜ä¸­ï¼Œæ¸©é¦¨æ™šé¤</p>
                    </div>
                    <div class="ml-auto w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-400">â€º</div>
                </div>

                <div onclick="selectContext('solo')" class="active-card glass-card p-6 flex items-center gap-5 cursor-pointer transition transform active:scale-95">
                    <div class="w-20 h-20 bg-purple-100 rounded-3xl flex items-center justify-center overflow-hidden">
                        <img src="" id="img-solo" class="img-3d w-16">
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-900">è‡ªå·±ç‹¬äº«</h3>
                        <p class="text-sm text-gray-500 mt-1">æƒ³åƒå•¥åƒå•¥ï¼Œæ”¾é£è‡ªæˆ‘</p>
                    </div>
                    <div class="ml-auto w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-400">â€º</div>
                </div>
            </div>
        </div>

        <!-- STEP 2: æ¨¡å¼é€‰æ‹© -->
        <div class="step-container" id="step-2">
            <div class="mt-10 mb-6">
                <h1 class="text-4xl font-bold text-[#1E1B4B]">Delivery or<br>Cooking?</h1>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div onclick="selectMode('takeout')" class="active-card glass-card p-5 flex flex-col items-center justify-center text-center h-56 cursor-pointer transition transform active:scale-95">
                    <div class="h-24 flex items-center justify-center mb-2">
                        <img src="" id="img-takeout" class="img-3d w-20">
                    </div>
                    <h3 class="text-lg font-bold text-gray-900">ç‚¹å¤–å–</h3>
                    <span class="text-xs text-purple-500 font-medium mt-2 bg-purple-50 px-3 py-1 rounded-full">Lazy Mode</span>
                </div>

                <div onclick="selectMode('cook')" class="active-card glass-card p-5 flex flex-col items-center justify-center text-center h-56 cursor-pointer transition transform active:scale-95">
                    <div class="h-24 flex items-center justify-center mb-2">
                        <img src="" id="img-cook" class="img-3d w-20">
                    </div>
                    <h3 class="text-lg font-bold text-gray-900">è‡ªå·±ç…®</h3>
                    <span class="text-xs text-orange-500 font-medium mt-2 bg-orange-50 px-3 py-1 rounded-full">Chef Mode</span>
                </div>
            </div>
        </div>

        <!-- STEP 3: ç±»å‹ç¡®è®¤ (è‡ªç…®) -->
        <div class="step-container" id="step-3">
            <div class="flex flex-col h-full justify-center items-center text-center">
                <h2 class="text-purple-500 font-bold tracking-wider uppercase text-sm mb-4">Cooking Category</h2>
                <div class="glass-card w-full p-10 relative overflow-hidden">
                    <div class="absolute -top-10 -right-10 w-32 h-32 bg-purple-100 rounded-full opacity-50"></div>
                    
                    <!-- å›¾ç‰‡å®¹å™¨ -->
                    <div class="h-40 flex items-center justify-center mb-6">
                        <img src="" id="type-img-disp" class="img-3d w-32 h-32 object-contain transition-all duration-300">
                    </div>
                    
                    <h1 class="text-3xl font-extrabold text-gray-900 mb-2" id="type-name-disp">ç‚’èœ</h1>
                    <p class="text-gray-400 text-sm">ä»Šå¤©çš„ä¸»é¢˜ç±»å‹</p>
                </div>

                <div class="mt-8 flex gap-4 w-full">
                    <button onclick="reRollType()" class="flex-1 py-4 rounded-3xl bg-white text-gray-900 font-bold shadow-sm border border-gray-100 active:scale-95 transition">æ¢ä¸ªç±»å‹</button>
                    <button onclick="generateMenuFromType()" class="flex-1 py-4 rounded-3xl bg-[#7C3AED] text-white font-bold shadow-lg shadow-purple-300 active:scale-95 transition">ç”Ÿæˆèœå•</button>
                </div>
            </div>
        </div>

        <!-- STEP 4: æœ€ç»ˆç»“æœ -->
        <div class="step-container" id="step-4">
            <div class="flex-1 flex flex-col pt-8">
                <div class="flex justify-center mb-4">
                    <div class="px-4 py-1 bg-black/5 rounded-full text-xs font-bold text-gray-500 uppercase tracking-wide" id="res-mode-badge">MODE</div>
                </div>
                <div class="flex-1 relative">
                    <div id="result-card-main" class="w-full h-full glass-card bg-white flex flex-col items-center justify-center text-center p-6 transition-all duration-300">
                        <!-- Dynamic Content -->
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨æ‚¬æµ®æ“ä½œæ  -->
        <div id="bottom-dock" class="floating-dock transform translate-y-[200%]">
            <div class="flex items-center gap-4 w-full">
                <button onclick="reRollDish()" class="w-14 h-14 rounded-full bg-gray-800 flex items-center justify-center text-2xl active:scale-90 transition text-white">ğŸ²</button>
                <div class="flex-1 text-center"><span class="text-white text-sm font-medium opacity-80">æ»¡æ„å—ï¼Ÿ</span></div>
                <button onclick="confirmChoice()" class="flex-1 h-14 rounded-[20px] bg-[#7C3AED] flex items-center justify-center text-white font-bold text-lg shadow-lg active:scale-95 transition">Confirm</button>
            </div>
        </div>

    </div>

    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-black/80 backdrop-blur-md text-white px-6 py-3 rounded-full text-sm font-medium shadow-2xl transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none z-50 flex items-center gap-2">
        <span class="text-green-400">âœ“</span> å·²è®°å½•åˆ°å†å²
    </div>

<script>
    let MENUS = {}; 
    let STATE = { context: null, mode: null, cookType: null, currentResult: null, step: 1 };
    const HIST_KEY = "dinner_app_history";

    /* ================= å›¾ç‰‡é…ç½®è¡¨ (ICON_MAP) ================= */
    // è¿™é‡Œçš„é“¾æ¥ä½¿ç”¨çš„æ˜¯ Microsoft 3D Fluent Emojis çš„å¼€æº CDN
    // å¦‚æœæ‚¨æƒ³æ¢æˆè‡ªå·±çš„å›¾ç‰‡ï¼Œç›´æ¥æŠŠ URL æ›¿æ¢æˆæ‚¨çš„å›¾ç‰‡åœ°å€å³å¯ (æ”¯æŒ png/jpg/gif)
    const ICON_MAP = {
        "shared": "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Microsoft-3D-Fluent-Emojis/master/Emojis/People/People%20Holding%20Hands/3D/people_holding_hands_3d.png",
        "solo": "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Microsoft-3D-Fluent-Emojis/master/Emojis/People/Person%20Shrugging%20Medium-Light%20Skin%20Tone/3D/person_shrugging_medium-light_skin_tone_3d.png",
        
        "takeout": "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Microsoft-3D-Fluent-Emojis/master/Emojis/Travel%20and%20places/Motor%20Scooter/3D/motor_scooter_3d.png",
        "cook": "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Microsoft-3D-Fluent-Emojis/master/Emojis/People/Cook%20Medium-Light%20Skin%20Tone/3D/cook_medium-light_skin_tone_3d.png",
        
        // çƒ¹é¥ªç±»å‹å¯¹åº”çš„å›¾ç‰‡
        "types": {
            "ç«é”…": "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Microsoft-3D-Fluent-Emojis/master/Emojis/Food%20and%20drink/Pot%20of%20Food/3D/pot_of_food_3d.png",
            "æ°´ç…®èœ": "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Microsoft-3D-Fluent-Emojis/master/Emojis/Food%20and%20drink/Pot%20of%20Food/3D/pot_of_food_3d.png",
            "ç‚’èœ": "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Microsoft-3D-Fluent-Emojis/master/Emojis/Food%20and%20drink/Shallow%20Pan%20of%20Food/3D/shallow_pan_of_food_3d.png",
            "ç„–èœ": "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Microsoft-3D-Fluent-Emojis/master/Emojis/Food%20and%20drink/Canned%20Food/3D/canned_food_3d.png",
            "é€Ÿé£Ÿ": "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Microsoft-3D-Fluent-Emojis/master/Emojis/Food%20and%20drink/Steaming%20Bowl/3D/steaming_bowl_3d.png",
            "æ–¹ä¾¿èœ": "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Microsoft-3D-Fluent-Emojis/master/Emojis/Food%20and%20drink/Takeout%20Box/3D/takeout_box_3d.png",
            "default": "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Microsoft-3D-Fluent-Emojis/master/Emojis/Food%20and%20drink/Fork%20and%20Knife%20with%20Plate/3D/fork_and_knife_with_plate_3d.png"
        },

        // ç»“æœé¡µçš„å›¾ç‰‡ (ä¸»èœå±•ç¤º)
        "results": {
            "takeout": "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Microsoft-3D-Fluent-Emojis/master/Emojis/Food%20and%20drink/Takeout%20Box/3D/takeout_box_3d.png",
            "meat": "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Microsoft-3D-Fluent-Emojis/master/Emojis/Food%20and%20drink/Cut%20of%20Meat/3D/cut_of_meat_3d.png",
            "main": "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Microsoft-3D-Fluent-Emojis/master/Emojis/Food%20and%20drink/Shallow%20Pan%20of%20Food/3D/shallow_pan_of_food_3d.png",
            "noodle": "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Microsoft-3D-Fluent-Emojis/master/Emojis/Food%20and%20drink/Steaming%20Bowl/3D/steaming_bowl_3d.png"
        }
    };

    /* ================= åˆå§‹åŒ–å›¾ç‰‡ ================= */
    function loadStaticImages() {
        document.getElementById('img-shared').src = ICON_MAP.shared;
        document.getElementById('img-solo').src = ICON_MAP.solo;
        document.getElementById('img-takeout').src = ICON_MAP.takeout;
        document.getElementById('img-cook').src = ICON_MAP.cook;
    }

    // å¤‡ä»½æ•°æ®
    const FALLBACK_DATA = {
      "solo": {
        "takeout": [ { "item": "èºè›³ç²‰", "weight": 4 }, { "item": "è€å‹ç²‰", "weight": 4 }, { "item": "å²­å‰ç¾Š", "weight": 2 }, { "item": "éœ¸ç¢—", "weight": 4 }, { "item": "åˆ˜æ–‡ç¥¥", "weight": 2 }, { "item": "æ›¹æ°é¸­è„–", "weight": 1 }, { "item": "é¸­é¢æ´¾", "weight": 2 } ],
        "cookTypes": [ { "type": "é€Ÿé£Ÿ", "weight": 5 }, { "type": "æ–¹ä¾¿èœ", "weight": 1 } ]
      },
      "shared": {
        "takeout": [ { "item": "å²­å‰ç¾Š", "weight": 3 }, { "item": "éœ¸ç¢—", "weight": 4 }, { "item": "æ²™å¿å°åƒ", "weight": 5 }, { "item": "çª‘é¸¡ç‹", "weight": 1 }, { "item": "å››å·è€ç›’é¥­", "weight": 1 }, { "item": "é¸­é¢æ´¾", "weight": 1 }, { "item": "å²­å—ç‰›æ‚", "weight": 2 }, { "item": "æ¯›è®°å†’èœ", "weight": 1 }, { "item": "è˜¸æ°´èœ", "weight": 2 }, { "item": "æ–—èˆŒå¹²æ‹Œç«é”…å†’èœ", "weight": 1 }, { "item": "è··è„šç‰›è‚‰", "weight": 2 }, { "item": "æ·®å—ç‰›è‚‰æ±¤", "weight": 2 } ],
        "cookTypes": [ { "type": "ç‚’èœ", "weight": 5 }, { "type": "æ°´ç…®èœ", "weight": 10 }, { "type": "ç«é”…", "weight": 1 }, { "type": "ç„–èœ", "weight": 6 }, { "type": "æ–¹ä¾¿èœ", "weight": 6 } ]
      },
      "pools": {
        "huncai": ["ç‰›è‚‰", "è™¾æ»‘", "å·´æ²™é±¼", "å»çš®é¸¡è…¿è‚‰", "è™¾ä»"],
        "sucai": ["åœŸè±†", "é‡‘é’ˆè‡", "è±†åˆ¶å“", "æµ·å¸¦", "è—•ç‰‡", "å†¬ç“œ", "é¦™è‡", "è¥¿è“èŠ±", "è´ç¬‹", "èåœ", "è±†èŠ½", "è¥¿è‘«èŠ¦", "æ´‹è‘±", "èŠ¦ç¬‹"],
        "yecai": ["ç”Ÿèœ", "å¨ƒå¨ƒèœ", "æ²¹éº¦èœ", "è èœ", "èŒ¼è’¿", "ä¸Šæµ·é’", "åŒ…èœ", "å°ç™½èœ"],
        "zhuchao": [ { "item": "å°ç‚’é»„ç‰›è‚‰", "weight": 5 }, { "item": "èŠ¹èœç‰›è‚‰æœ«", "weight": 5 }, { "item": "è’œè‹—ç‚’è…Šè‚‰", "weight": 1 }, { "item": "ç›è‘±é¸¡èƒ¸è‚‰", "weight": 2 }, { "item": "é¸¡èƒ¸è‚‰ç‚’å£è˜‘", "weight": 2 } ],
        "fuchao": [ { "item": "ç•ªèŒ„ç‚’è›‹", "weight": 4 }, { "item": "æ‰‹æ’•åŒ…èœ", "weight": 4 }, { "item": "è™¾ä»æ»‘è›‹", "weight": 2 }, { "item": "ç‚’æ—¶è”¬", "weight": 5 }, { "item": "åŒ…èœæŠ±è›‹", "weight": 5 }, { "item": "è™¾æ»‘è—•å¸¦ç‚’èŠ¦ç¬‹", "weight": 3 } ],
        "mencai": [ { "item": "å£è˜‘", "weight": 2 }, { "item": "å¨ƒå¨ƒèœ", "weight": 2 }, { "item": "èƒ¡èåœè±†èŠ½", "weight": 1 }, { "item": "èŠ¹èœ", "weight": 2 }, { "item": "èåœä¸", "weight": 1 } ],
        "sushi": [ { "item": "ç±³ç²‰ç±»", "weight": 4 }, { "item": "èºè›³ç²‰(è‡ªç…®)", "weight": 3 }, { "item": "æ–¹ä¾¿é¢", "weight": 4 } ],
        "fangbiancai": [ { "item": "å°ç‚’é»„ç‰›è‚‰(ç›’é©¬)", "weight": 1 }, { "item": "ç›è‘±é¸¡è…¿æ’(ç›’é©¬)", "weight": 1 }, { "item": "æ³¡æ¤’ç‰›è‚‰ä¸(ç›’é©¬)", "weight": 1 }, { "item": "é²œæ¤’è¾£å­é¸¡(ç›’é©¬)", "weight": 1 }, { "item": "è’œè–¹è‚‰ä¸(ç›’é©¬)", "weight": 1 }, { "item": "è¾£æ¤’å°ç‚’è‚‰(ç›’é©¬)", "weight": 1 }, { "item": "é’æ¤’è‚‰ä¸(ç›’é©¬)", "weight": 1 }, { "item": "è‚‰æœ«è±‡è±†(ç›’é©¬)", "weight": 1 }, { "item": "é»‘æ¤’ç‰›è‚‰ç²’(ç›’é©¬)", "weight": 1 }, { "item": "é±¼é¦™è‚‰ä¸(ç›’é©¬)", "weight": 1 }, { "item": "é¦™è‘±é¦™èœæ‹Œç‰›è‚‰(ç›’é©¬)", "weight": 1 }, { "item": "å®«ä¿é¸¡ä¸(ç›’é©¬)", "weight": 1 }, { "item": "é…¸èœé±¼(ç›’é©¬)", "weight": 1 }, { "item": "é’æ¤’é¸¡(æœ´æœ´)", "weight": 1 }, { "item": "è‚‰æœ«ç¬‹ä¸(æœ´æœ´)", "weight": 1 }, { "item": "å°ç¬‹ç‚’è‚‰(æœ´æœ´)", "weight": 1 }, { "item": "é²œåˆ¶åŒæ¤’è‚‰ä¸(æœ´æœ´)", "weight": 1 }, { "item": "é²œåˆ¶é±¼é¦™è‚‰ä¸(æœ´æœ´)", "weight": 1 }, { "item": "é²œåˆ¶çƒ‚è‚‰è±‡è±†(æœ´æœ´)", "weight": 1 }, { "item": "é²œåˆ¶å®«ä¿é¸¡ä¸(æœ´æœ´)", "weight": 1 }, { "item": "é’èŠ±æ¤’å…”ä¸(æœ´æœ´)", "weight": 1 }, { "item": "é¸¡ç±³èŠ½èœ(æœ´æœ´)", "weight": 1 }, { "item": "è‡ªè´¡å°ç…é¸¡(æœ´æœ´)", "weight": 1 }, { "item": "å­å§œé¸­ä¸(æœ´æœ´)", "weight": 1 }, { "item": "é²œåˆ¶æ³¡æ¤’ç‰›è‚‰ä¸(æœ´æœ´)", "weight": 1 }, { "item": "é»‘æ¤’èŠ¦ç¬‹ç‰›è‚‰ç²’(æœ´æœ´)", "weight": 1 }, { "item": "å­å§œé²œé”…å…”(æœ´æœ´)", "weight": 1 }, { "item": "ç›è‘±é¸¡è…¿æ’(æœ´æœ´)", "weight": 1 } ]
      }
    };

    async function initData() {
        loadStaticImages(); // åŠ è½½é¦–é¡µå›¾ç‰‡
        try {
            const response = await fetch('menu_data.json?t=' + new Date().getTime());
            if (!response.ok) throw new Error("Fetch Failed");
            MENUS = await response.json();
        } catch (e) {
            console.warn("Using fallback data");
            MENUS = FALLBACK_DATA;
        }
    }

    // --- ç»Ÿä¸€å¯¼èˆªå¤„ç† ---
    function handleNavClick() {
        if (STATE.step === 1) location.href = '../index.html';
        else if (STATE.step === 2) goToStep(1);
        else if (STATE.step === 3) goToStep(2);
        else if (STATE.step === 4) { if (STATE.mode === 'takeout') goToStep(2); else goToStep(3); }
    }

    function updateNavButton() {
        const btn = document.getElementById('nav-btn');
        if (STATE.step === 1) {
            btn.innerHTML = 'ğŸ ';
            btn.classList.remove('text-2xl', 'text-gray-600');
            btn.classList.add('text-xl');
        } else {
            btn.innerHTML = 'â€¹'; 
            btn.classList.remove('text-xl');
            btn.classList.add('text-2xl', 'text-gray-600');
        }
    }

    function goToStep(stepNum) {
        STATE.step = stepNum;
        updateNavButton();
        document.querySelectorAll('.step-container').forEach(el => { el.classList.remove('active', 'prev'); });
        for(let i=1; i<stepNum; i++) { document.getElementById(`step-${i}`).classList.add('prev'); }
        document.getElementById(`step-${stepNum}`).classList.add('active');
        
        const dock = document.getElementById('bottom-dock');
        if (stepNum === 4) dock.classList.remove('translate-y-[200%]'); else dock.classList.add('translate-y-[200%]');
    }

    function selectContext(val) { STATE.context = val; goToStep(2); }
    function selectMode(val) { 
        STATE.mode = val; 
        if (val === 'takeout') { generateResultTakeout(); goToStep(4); } 
        else { generateCookType(); goToStep(3); }
    }
    function goBackFromResult() { if (STATE.mode === 'takeout') goToStep(2); else goToStep(3); }

    function getHistory() { const h = localStorage.getItem(HIST_KEY); return h ? JSON.parse(h) : []; }
    function isRecent(name) {
        const hist = getHistory();
        const now = new Date().getTime();
        const threeDays = 3 * 24 * 60 * 60 * 1000;
        return hist.filter(r => (now - r.date) < threeDays).some(r => r.item === name);
    }
    function weightedRandom(list) {
        if (!list || !list.length) return { item: "æ— æ•°æ®", type: "æ— æ•°æ®" };
        let total = list.reduce((sum, i) => sum + i.weight, 0);
        let r = Math.random() * total;
        for (let i of list) { if (r < i.weight) return i; r -= i.weight; }
        return list[0];
    }
    function multiRandomUnique(list, count) {
        if (!list) return [];
        return [...list].sort(() => 0.5 - Math.random()).slice(0, count);
    }

    function generateCookType() {
        const type = weightedRandom(MENUS[STATE.context].cookTypes).type;
        STATE.cookType = type;
        
        document.getElementById('type-name-disp').innerText = type;
        
        // æ ¹æ®ç±»å‹åç§°è·å–å›¾ç‰‡URL (æ¨¡ç³ŠåŒ¹é…)
        let imgUrl = ICON_MAP.types.default;
        for(let key in ICON_MAP.types) {
            if(type.includes(key)) { imgUrl = ICON_MAP.types[key]; break; }
        }
        
        document.getElementById('type-img-disp').src = imgUrl;
    }
    function reRollType() {
        const el = document.getElementById('type-img-disp');
        el.style.transform = "rotateX(90deg)";
        setTimeout(() => { generateCookType(); el.style.transform = "rotateX(0deg)"; }, 150);
    }
    function generateMenuFromType() { generateResultCook(); goToStep(4); }

    function reRollDish() {
        const card = document.getElementById('result-card-main');
        card.style.transform = "scale(0.9) translateY(20px)";
        card.style.opacity = "0";
        setTimeout(() => {
            if (STATE.mode === 'takeout') generateResultTakeout(); else generateResultCook();
            card.style.transform = "scale(1) translateY(0)";
            card.style.opacity = "1";
        }, 300);
    }

    // --- æ¸²æŸ“æ ¸å¿ƒ (å›¾ç‰‡ç‰ˆ) ---
    function generateResultTakeout() {
        const list = MENUS[STATE.context].takeout;
        let choice = weightedRandom(list);
        for(let k=0; k<5; k++) { if(!isRecent(choice.item)) break; choice = weightedRandom(list); }
        
        renderUI("ğŸ›µ", "å¤–å–", choice.item, `
            <div class="h-32 flex items-center justify-center mb-6">
                <img src="${ICON_MAP.results.takeout}" class="img-3d w-28 h-28 object-contain">
            </div>
            <h2 class="text-3xl font-extrabold text-gray-900 mb-2 px-4 leading-tight">${choice.item}</h2>
            <p class="text-purple-500 font-medium bg-purple-50 px-4 py-1 rounded-full inline-block mt-2">é¢„è®¡ 30 åˆ†é’Ÿé€è¾¾</p>
        `);
    }

    function generateResultCook() {
        const type = STATE.cookType;
        const pools = MENUS.pools;
        let main = "", html = "";

        if (type.includes('ç«é”…') || type.includes('æ°´ç…®')) {
            let meat = multiRandomUnique(pools.huncai, 1)[0];
            for(let k=0; k<5; k++) { if(!isRecent(meat)) break; meat = multiRandomUnique(pools.huncai, 1)[0]; }
            const v = multiRandomUnique(pools.sucai, 3).join('ã€');
            main = meat;
            html = `
                <div class="h-24 flex items-center justify-center mb-2">
                    <img src="${ICON_MAP.results.meat}" class="img-3d w-24 h-24 object-contain">
                </div>
                <h2 class="text-3xl font-extrabold text-gray-900 mb-1">${meat}</h2>
                <p class="text-gray-400 text-sm mb-6 uppercase tracking-wide font-bold">${type}</p>
                <div class="w-full bg-gray-50 rounded-2xl p-4 text-left">
                    <span class="text-xs text-gray-400 font-bold uppercase">é…èœå»ºè®®</span>
                    <p class="text-gray-700 mt-1 font-medium">${multiRandomUnique(pools.yecai, 1)[0]}ã€${v}</p>
                </div>
            `;
        } else if (type === 'ç‚’èœ') {
            main = weightedRandom(pools.zhuchao).item;
            const side = weightedRandom(pools.fuchao).item;
            html = `
                <div class="h-24 flex items-center justify-center mb-2">
                    <img src="${ICON_MAP.results.main}" class="img-3d w-24 h-24 object-contain">
                </div>
                <div class="space-y-3 w-full">
                    <div class="bg-orange-50 p-4 rounded-3xl border border-orange-100">
                        <span class="text-xs text-orange-400 font-bold uppercase">ä¸»èœ</span>
                        <div class="text-xl font-bold text-gray-800">${main}</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-3xl border border-green-100">
                        <span class="text-xs text-green-500 font-bold uppercase">è¾…èœ</span>
                        <div class="text-xl font-bold text-gray-800">${side}</div>
                    </div>
                </div>
            `;
        } else if (type === 'ç„–èœ') {
            const base = weightedRandom(pools.mencai).item;
            let meat = multiRandomUnique(pools.huncai, 1)[0];
            main = `${base}ç„–${meat}`;
            html = `
                <div class="h-32 flex items-center justify-center mb-6">
                    <img src="${ICON_MAP.types['ç„–èœ']}" class="img-3d w-28 h-28 object-contain">
                </div>
                <h2 class="text-3xl font-extrabold text-gray-900 leading-tight px-2">${main}</h2>
                <p class="text-sm text-gray-400 mt-2 bg-gray-100 px-3 py-1 rounded-full inline-block">ä¸‡ç‰©çš†å¯ç„–</p>
            `;
        } else {
            let pool = type === 'é€Ÿé£Ÿ' ? 'sushi' : 'fangbiancai';
            main = weightedRandom(pools[pool]).item;
            html = `
                <div class="h-32 flex items-center justify-center mb-6">
                    <img src="${ICON_MAP.results.noodle}" class="img-3d w-28 h-28 object-contain">
                </div>
                <h2 class="text-3xl font-extrabold text-gray-900 leading-tight px-4">${main}</h2>
                <p class="text-sm text-gray-400 mt-2">å¿«é€Ÿè§£å†³æˆ˜æ–—</p>
            `;
        }
        renderUI("ğŸ‘¨â€ğŸ³", type, main, html);
    }

    function renderUI(icon, modeText, resultName, contentHTML) {
        STATE.currentResult = resultName;
        document.getElementById('res-mode-badge').innerText = modeText;
        document.getElementById('result-card-main').innerHTML = contentHTML;
    }

    function confirmChoice() {
        if (!STATE.currentResult) return;
        const hist = getHistory();
        hist.unshift({ date: new Date().getTime(), item: STATE.currentResult, mode: STATE.mode });
        if(hist.length > 20) hist.pop();
        localStorage.setItem(HIST_KEY, JSON.stringify(hist));
        
        const t = document.getElementById('toast');
        t.classList.remove('opacity-0', 'translate-y-[-20px]');
        setTimeout(() => {
            t.classList.add('opacity-0', 'translate-y-[-20px]');
            goToStep(1);
        }, 1500);
    }

    initData();
</script>
</body>
</html>
