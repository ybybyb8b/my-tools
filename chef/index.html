<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç™¾å¹´ç¥å¨ Â· æ™ºèƒ½ç‚¹é¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- ç°ä»£æç®€è®¾è®¡ç³»ç»Ÿ (Figma Style) --- */
        :root {
            --bg-body: #F5F7FA;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --accent: #10B981; /* æç®€ç»¿ */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        /* å¼¥æ•£èƒŒæ™¯å…‰ */
        .ambient-light {
            position: fixed;
            top: -10%; left: -10%;
            width: 80%; height: 60%;
            background: radial-gradient(circle, rgba(16, 185, 129, 0.08) 0%, rgba(255,255,255,0) 70%);
            z-index: -1;
            pointer-events: none;
        }

        /* è¶…æŸ”å’Œå¡ç‰‡ */
        .soft-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.05);
            border-radius: 24px;
        }

        /* è¾“å…¥æ¡†æ ·å¼ */
        .modern-input {
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 16px;
            transition: all 0.2s;
        }
        .modern-input:focus-within {
            background: #FFFFFF;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
        }

        /* æŒ‰é’®åŠ¨æ•ˆ */
        .btn-press { transition: transform 0.1s; }
        .btn-press:active { transform: scale(0.96); }

        /* ç»“æœåˆ—è¡¨åŠ¨ç”» */
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: slideUpFade 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-5 pb-24 flex flex-col max-w-md mx-auto relative">

    <!-- èƒŒæ™¯è£…é¥° -->
    <div class="ambient-light"></div>

    <!-- Header -->
    <header class="mt-4 mb-8 flex justify-between items-center">
        <div>
            <div class="text-xs font-bold text-emerald-600 uppercase tracking-wider mb-1">Smart Menu</div>
            <h1 class="text-2xl font-bold text-gray-900 tracking-tight">ç™¾å¹´ç¥å¨</h1>
        </div>
        <div id="status-badge" class="px-3 py-1 rounded-full bg-gray-100 text-gray-400 text-xs font-medium">
            Connecting...
        </div>
    </header>

    <!-- ä¸»è¦æ“ä½œåŒº -->
    <div class="soft-card p-6 mb-6">
        <label class="block text-sm font-medium text-gray-500 mb-3">ç”¨é¤äººæ•° / Diners</label>
        <div class="flex items-center gap-4">
            <div class="modern-input flex-1 h-14 flex items-center px-4">
                <span class="text-xl mr-3">ğŸ‘¥</span>
                <input type="number" id="pCount" value="10" class="w-full bg-transparent outline-none text-xl font-bold text-gray-800 placeholder-gray-300" placeholder="10">
            </div>
            <button id="genBtn" onclick="generate()" disabled class="btn-press h-14 w-14 rounded-2xl bg-emerald-500 text-white flex items-center justify-center shadow-lg shadow-emerald-200 disabled:opacity-50 disabled:shadow-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                </svg>
            </button>
        </div>
    </div>

    <!-- ç»“æœå±•ç¤ºåŒº -->
    <div id="result-area" class="hidden">
        
        <!-- æ¦‚è§ˆå¡ç‰‡ -->
        <div class="flex gap-3 mb-6 animate-enter" style="animation-delay: 0.05s">
            <div class="flex-1 bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                <div class="text-xs text-gray-400 font-medium uppercase">æ€»é¢„ç®—</div>
                <div class="text-xl font-bold text-gray-800 mt-1" id="res-total">Â¥0</div>
            </div>
            <div class="flex-1 bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                <div class="text-xs text-gray-400 font-medium uppercase">äººå‡</div>
                <div class="text-xl font-bold text-emerald-500 mt-1" id="res-avg">Â¥0</div>
            </div>
        </div>

        <!-- èœå•åˆ—è¡¨ -->
        <div class="soft-card p-1 animate-enter" style="animation-delay: 0.1s">
            <div class="px-5 py-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-bold text-gray-800">Generated Menu</h3>
                <span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-md" id="res-count">0 é“èœ</span>
            </div>
            
            <div id="menu-list" class="divide-y divide-gray-50">
                <!-- èœå“é¡¹å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
            </div>
        </div>

        <!-- åº•éƒ¨æ“ä½œæ  -->
        <div class="fixed bottom-6 left-0 right-0 px-5 flex justify-center gap-3 z-50 animate-enter" style="animation-delay: 0.2s">
            <button onclick="copyMenu()" class="btn-press flex-1 bg-gray-900 text-white h-14 rounded-full font-semibold shadow-xl flex items-center justify-center gap-2 max-w-[200px]">
                <span>ğŸ“‹ å¤åˆ¶èœå•</span>
            </button>
            <button onclick="clearHist()" class="btn-press w-14 h-14 bg-white text-gray-500 rounded-full shadow-lg flex items-center justify-center border border-gray-100">
                ğŸ—‘ï¸
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-black/80 backdrop-blur-md text-white px-6 py-3 rounded-full text-sm font-medium shadow-2xl transition-all duration-300 opacity-0 -translate-y-4 pointer-events-none z-50">
        å·²å¤åˆ¶
    </div>

<script>
    /* ================= æ ¸å¿ƒé€»è¾‘ ================= */
    let db = [];
    let hist = [];
    let best = null;
    const HIST_KEY = 'sz_hist_v10';

    async function init() {
        try {
            const res = await fetch('dishes.json?t=' + new Date().getTime());
            if(!res.ok) throw new Error("Load Failed");
            const raw = await res.json();
            
            // æ•°æ®å¤„ç†ï¼šå¦‚æœæ²¡æœ‰æ‰‹åŠ¨æŒ‡å®š sizeï¼Œåˆ™è‡ªåŠ¨æ¨æ–­
            db = raw.map(d => ({
                ...d, 
                size: d.size || autoSize(d.name), 
                mutex: d.mutex || ""
            }));

            const h = localStorage.getItem(HIST_KEY);
            hist = h ? JSON.parse(h) : [];

            const badge = document.getElementById('status-badge');
            badge.textContent = "Ready";
            badge.className = "px-3 py-1 rounded-full bg-emerald-50 text-emerald-600 text-xs font-medium border border-emerald-100";
            document.getElementById('genBtn').disabled = false;
        } catch(e) {
            const badge = document.getElementById('status-badge');
            badge.textContent = "Error";
            badge.className = "px-3 py-1 rounded-full bg-red-50 text-red-500 text-xs font-medium";
        }
    }

    function autoSize(n) {
        if(n.includes("å…¨å®¶ç¦")) return 'L';
        if(n.includes("å°ä»½")||n.includes("ä¸€æ¡")) return 'S';
        if((n.includes("é±¼")||n.includes("é¸¡")||n.includes("å…”")||n.includes("è›™")||n.includes("é¸­")) && !n.includes("ç‰‡") && !n.includes("ä¸") && !n.includes("ä¸")) return 'L';
        return 'M';
    }

    function shuffle(a) { return a.sort(()=>Math.random()-0.5); }

    function generate() {
        const num = parseInt(document.getElementById('pCount').value);
        if(num<2) { alert("è‡³å°‘2äººç”¨é¤"); return; }

        const tables = Math.ceil(num/11);
        const pPerT = Math.ceil(num/tables);
        const limit = pPerT * 30; // äººå‡30é¢„ç®—
        const totalD = Math.max(2, pPerT - 1); // èœå“æ•°é‡é€»è¾‘

        // è¿‡æ»¤å†å²
        const ban = new Set();
        hist.forEach(h => h.dishes.forEach(d => ban.add(d)));
        let pool = db.filter(d => !ban.has(d.name));
        if(pool.length < 10) pool = db;

        const cats = {
            soup: pool.filter(d=>d.type==="æ±¤å“"),
            main: pool.filter(d=>d.type==="ä¸»è¤"),
            side: pool.filter(d=>d.type==="è¾…è¤"),
            veg: pool.filter(d=>d.type==="ç´ èœ"),
            cold: pool.filter(d=>d.type==="å‡‰èœ"),
            oth: pool.filter(d=>["ä¸‹é¥­èœ","å°åƒ"].includes(d.type))
        };

        let final = null;
        let minDiff = 99999;

        // å°è¯• 500 æ¬¡å¯»æ‰¾æœ€ä½³ç»„åˆ
        for(let k=0; k<500; k++) {
            let m = [];
            let p = 0;
            let slots = totalD;
            let smallCount = 0; // ã€æ–°è§„åˆ™ã€‘å½“å‰èœå•ä¸­ S ç èœçš„æ•°é‡

            // æ ¸å¿ƒç­›é€‰å‡½æ•°ï¼šåŠ å…¥ S ç é™åˆ¶
            const pick = (arr) => {
                let v = arr.filter(x => {
                    // åŸºç¡€å»é‡
                    if (m.includes(x)) return false;
                    // äº’æ–¥å»é‡
                    if (x.mutex && m.some(ex => ex.mutex === x.mutex)) return false;
                    // ã€æ–°è§„åˆ™ã€‘å¦‚æœå·²ç»æœ‰1ä¸ªSèœäº†ï¼Œå°±ä¸å†é€‰Sèœ
                    if (x.size === 'S' && smallCount >= 1) return false;
                    return true;
                });
                if(!v.length) return null;
                return shuffle(v)[0];
            };

            const addDish = (d) => {
                if(d) {
                    m.push(d);
                    p += d.price;
                    slots--;
                    if(d.size === 'S') smallCount++; // è®¡æ•°å™¨+1
                }
            };

            // 1. å¿…é€‰æ±¤
            if(cats.soup.length) addDish(pick(cats.soup));

            // 2. å¿…é€‰ä¸»è¤ (ä¼˜å…ˆå¤§ä»½)
            const mL = cats.main.filter(d=>d.size==='L');
            const mM = cats.main.filter(d=>d.size==='M');
            
            if(slots > 0) {
                // åªè¦ä¸æ˜¯å¤ªå°çš„æ¡Œï¼Œéƒ½ä¼˜å…ˆå°è¯•å¤§èœ
                let d1 = pick(mL) || pick(mM) || pick(cats.main);
                addDish(d1);
            }

            // 3. å¿…é€‰ç´ èœ
            if(slots > 0 && cats.veg.length) addDish(pick(cats.veg));

            // 4. å¡«å……å‰©ä½™ (æ ¹æ®å·²é€‰çš„è¤èœæ•°é‡å†³å®šå¡«ä»€ä¹ˆ)
            let meatCount = m.filter(d=>d.type.includes('è¤')).length;
            let targetMeat = (pPerT < 7) ? 3 : 4;

            while(slots > 0) {
                let sub = [];
                // è‚‰ä¸å¤Ÿä¼˜å…ˆè¡¥è‚‰ï¼Œè‚‰å¤Ÿäº†è¡¥å…¶ä»–
                if(meatCount < targetMeat) sub = [...cats.side, ...cats.main];
                else sub = [...cats.side, ...cats.oth, ...cats.veg, ...cats.cold];
                
                let d = pick(sub);
                if(!d) break; // æ²¡èœé€‰äº†
                
                addDish(d);
                if(d.type.includes('è¤')) meatCount++;
            }

            // è®°å½•æœ€ä¼˜è§£ (æœ€æ¥è¿‘é¢„ç®—ä¸”ä¸è¶…è¿‡å¤ªå¤šçš„)
            if(p <= limit * 1.1) { 
                final = {m, p}; 
                // å¦‚æœå®Œç¾ç¬¦åˆé¢„ç®—ï¼Œç›´æ¥è·³å‡º
                if (p <= limit) break;
            }
            else if(p < minDiff) { 
                minDiff = p; 
                final = {m, p}; 
            }
        }

        if(!final) { alert("ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•"); return; }
        best = final;
        render(final, num, tables, pPerT, limit);
    }

    function render(plan, total, t, ppt, limit) {
        document.getElementById('result-area').classList.remove('hidden');
        
        // æ’åºï¼šæ±¤ -> ä¸»è¤ -> è¾…è¤ ...
        const ord = {"æ±¤å“":1,"ä¸»è¤":2,"è¾…è¤":3,"å‡‰èœ":4,"ä¸‹é¥­èœ":5,"ç´ èœ":6,"å°åƒ":7};
        plan.m.sort((a,b)=>(ord[a.type]||9)-(ord[b.type]||9));

        // æ¸²æŸ“åˆ—è¡¨
        const listEl = document.getElementById('menu-list');
        listEl.innerHTML = plan.m.map((d, i) => {
            // æ ‡ç­¾æ ·å¼
            let tag = '';
            if(d.size === 'L') tag = `<span class="ml-2 px-1.5 py-0.5 rounded text-[10px] font-bold bg-orange-100 text-orange-600">å¤§</span>`;
            else if(d.size === 'S') tag = `<span class="ml-2 px-1.5 py-0.5 rounded text-[10px] font-bold bg-blue-50 text-blue-500">å°</span>`;
            
            return `
                <div class="p-4 flex justify-between items-center hover:bg-gray-50 transition-colors">
                    <div class="flex items-start gap-3">
                        <div class="text-sm font-bold text-gray-400 w-6 pt-1">0${i+1}</div>
                        <div>
                            <div class="text-gray-900 font-medium flex items-center">
                                ${d.name} ${tag}
                            </div>
                            <div class="text-xs text-gray-400 mt-0.5">${d.type}</div>
                        </div>
                    </div>
                    <div class="text-gray-900 font-semibold">Â¥${d.price}</div>
                </div>
            `;
        }).join('');

        // æ›´æ–°æ•°æ®æ¦‚è§ˆ
        document.getElementById('res-total').innerText = `Â¥${plan.p.toFixed(0)}`;
        
        let avg = (plan.p/ppt).toFixed(0);
        let avgEl = document.getElementById('res-avg');
        avgEl.innerText = `Â¥${avg}`;
        avgEl.className = `text-xl font-bold mt-1 ${plan.p <= limit ? 'text-emerald-500' : 'text-orange-500'}`;
        
        document.getElementById('res-count').innerText = `${plan.m.length} é“èœ`;
        
        // æ»šåŠ¨åˆ°ç»“æœåŒº
        document.getElementById('result-area').scrollIntoView({behavior: 'smooth'});
    }

    function copyMenu() {
        if(!best) return;
        
        const num = document.getElementById('pCount').value;
        const avg = (best.p / (num/Math.ceil(num/11))).toFixed(1);
        let text = `ğŸ“… ç™¾å¹´ç¥å¨è®¢é¤å• (${new Date().toLocaleDateString()})\n`;
        text += `ğŸ‘¥ äººæ•°: ${num}äºº\n------------------\n`;
        
        const ord = {"æ±¤å“":1,"ä¸»è¤":2,"è¾…è¤":3,"å‡‰èœ":4,"ä¸‹é¥­èœ":5,"ç´ èœ":6,"å°åƒ":7};
        best.m.sort((a,b)=>(ord[a.type]||9)-(ord[b.type]||9));

        best.m.forEach((d, i) => {
            let sizeStr = d.size === 'L' ? '[å¤§]' : (d.size === 'S' ? '[å°]' : '');
            text += `${i+1}. ${d.name}${sizeStr}  Â¥${d.price}\n`;
        });

        text += `------------------\n`;
        text += `ğŸ’° æ€»è®¡: Â¥${best.p.toFixed(0)}  (äººå‡ Â¥${avg})`;

        // å­˜å…¥å†å²
        hist.unshift({date:new Date().toLocaleDateString(), dishes:best.m.map(d=>d.name)});
        if(hist.length>5) hist = hist.slice(0,5);
        localStorage.setItem(HIST_KEY, JSON.stringify(hist));

        navigator.clipboard.writeText(text).then(() => showToast("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"));
    }

    function clearHist() {
        if(confirm("æ¸…é™¤â€œåƒè¿‡çš„èœâ€è®°å½•ï¼Ÿ")) {
            hist = [];
            localStorage.removeItem(HIST_KEY);
            showToast("å†å²è®°å½•å·²é‡ç½®");
        }
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.remove('opacity-0', '-translate-y-4');
        setTimeout(() => t.classList.add('opacity-0', '-translate-y-4'), 2000);
    }

    init();
</script>
</body>
</html>
