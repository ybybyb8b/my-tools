<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç™¾å¹´ç¥å¨ - æ™ºèƒ½ç‚¹é¤</title>
    <style>
        /* V12.0 ç²‰è“é©¬å¡é¾™é…è‰² */
        :root {
            --primary: #FF8CA1;      /* æ¨±èŠ±ç²‰ */
            --primary-hover: #F06A85; 
            --secondary: #74B9FF;    /* å¤©ç©ºè“ */
            --bg: #F0F4F8;           
            --card-bg: #FFFFFF;
            --text-main: #57606F;    
            --text-light: #A4B0BE;
            --radius: 20px;
            --shadow: 0 8px 20px rgba(166, 179, 194, 0.2);
        }

        body {
            font-family: -apple-system, "Microsoft YaHei", sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .wrapper {
            max-width: 600px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #FF8CA1 0%, #74B9FF 100%);
            padding: 30px 20px;
            text-align: center;
            color: white;
        }
        .header h1 { margin: 0; font-size: 22px; letter-spacing: 1px; }
        .status-bar { font-size: 12px; opacity: 0.9; margin-top: 5px; }

        .content { padding: 30px 20px; }

        /* è¾“å…¥åŒº */
        .control-panel {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        .p-label { font-size: 15px; color: var(--text-light); }
        input[type="number"] {
            width: 70px;
            padding: 10px;
            border: 2px solid #F1F2F6;
            border-radius: 12px;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            color: var(--primary);
            outline: none;
        }
        input[type="number"]:focus { border-color: var(--primary); }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(255, 140, 161, 0.4);
            transition: 0.2s;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }
        
        .btn-ghost {
            background: transparent; color: var(--text-light); border: 1px solid #eee; 
            padding: 8px 15px; font-size: 12px; box-shadow: none;
        }

        /* ç»“æœå°ç¥¨ */
        .receipt-card {
            background: #fff;
            border: 1px solid #F1F2F6;
            border-radius: 16px;
            padding: 20px;
            animation: slideUp 0.4s ease;
            display: none;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .summary-box {
            background: linear-gradient(to right, #e3f2fd, #f3e5f5);
            color: #57606f;
            padding: 15px;
            border-radius: 12px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        td { padding: 10px 0; border-bottom: 1px solid #f8f9fa; }
        .price { text-align: right; font-weight: 500; }
        
        .tag { padding: 3px 8px; border-radius: 10px; font-size: 11px; margin-left: 5px; vertical-align: middle; }
        .t-L { background: #ffeaa7; color: #e17055; }
        .t-M { background: #74b9ff; color: #fff; }
        .t-S { background: #55efc4; color: #00b894; }

        .copy-btn {
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            background: var(--secondary);
            box-shadow: 0 4px 10px rgba(116, 185, 255, 0.3);
        }
        
        .footer-actions {
            margin-top: 30px;
            text-align: center;
            border-top: 1px dashed #eee;
            padding-top: 20px;
        }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="header">
        <h1>ğŸ± ç™¾å¹´ç¥å¨ Â· æ™ºèƒ½ç‚¹é¤</h1>
        <div class="status-bar" id="status">æ­£åœ¨è¿æ¥èœå•æ•°æ®åº“...</div>
    </div>

    <div class="content">
        <div class="control-panel">
            <span class="p-label">ç”¨é¤äººæ•°</span>
            <input type="number" id="pCount" value="10">
            <button class="btn" id="genBtn" onclick="generate()" disabled>ğŸª„ ç”Ÿæˆ</button>
        </div>

        <div id="res" class="receipt-card">
            <div id="sum" class="summary-box"></div>
            <div id="list"></div>
            <div id="bud" style="margin-top:15px; text-align:center; font-size:13px; font-weight:bold; color:var(--text-light);"></div>
            
            <button class="btn copy-btn" onclick="copyMenu()">ğŸ“‹ å¤åˆ¶èœå•æ–‡æœ¬</button>
        </div>

        <div class="footer-actions">
            <button class="btn btn-ghost" onclick="clearHist()">ğŸ—‘ï¸ æ¸…ç©ºâ€œåƒè¿‡â€çš„å†å²è®°å½•</button>
        </div>
    </div>
</div>

<script>
    let db = [];
    let hist = [];
    let best = null;
    const HIST_KEY = 'sz_hist_v10'; // ä»…ä¿ç•™å†å²è®°å½•ï¼Œä¸å­˜èœå•

    // åˆå§‹åŒ–
    async function init() {
        try {
            const res = await fetch('dishes.json?t=' + new Date().getTime());
            if(!res.ok) throw new Error("åŠ è½½å¤±è´¥");
            const raw = await res.json();
            
            // è‡ªåŠ¨è®¡ç®—åˆ†é‡ (ä¿ç•™ä¹‹å‰çš„é€»è¾‘)
            db = raw.map(d => ({
                ...d, 
                size: autoSize(d.name), 
                mutex: d.mutex || ""
            }));

            // è¯»å–æœ¬åœ°å†å² (é¿å…é‡å¤)
            const h = localStorage.getItem(HIST_KEY);
            hist = h ? JSON.parse(h) : [];

            document.getElementById('status').textContent = "âœ… èœå•å·²åŒæ­¥";
            document.getElementById('genBtn').disabled = false;
        } catch(e) {
            document.getElementById('status').textContent = "âŒ æ— æ³•åŠ è½½ dishes.json";
        }
    }

    function autoSize(n) {
        if(n.includes("å…¨å®¶ç¦")) return 'L';
        if(n.includes("å°ä»½")||n.includes("ä¸€æ¡")) return 'S';
        if((n.includes("é±¼")||n.includes("é¸¡")||n.includes("å…”")||n.includes("è›™")||n.includes("é¸­")) && !n.includes("ç‰‡") && !n.includes("ä¸") && !n.includes("ä¸")) return 'L';
        return 'M';
    }

    function shuffle(a) { return a.sort(()=>Math.random()-0.5); }
    
    // æ ¸å¿ƒç”Ÿæˆé€»è¾‘ (ä¿æŒä¸å˜)
    function generate() {
        const num = parseInt(document.getElementById('pCount').value);
        if(num<2) { alert("è‡³å°‘2äººç”¨é¤"); return; }

        const tables = Math.ceil(num/11);
        const pPerT = Math.ceil(num/tables);
        const limit = pPerT * 30;
        const isMega = pPerT >= 8;   
        const isLarge = pPerT === 7; 
        const isSmall = pPerT < 7;
        const totalD = Math.max(2, pPerT - 1);

        // è¿‡æ»¤å†å²
        const ban = new Set();
        hist.forEach(h => h.dishes.forEach(d => ban.add(d)));
        let pool = db.filter(d => !ban.has(d.name));
        if(pool.length < 10) pool = db; // èœä¸å¤Ÿäº†å°±å¿½ç•¥å†å²

        const cats = {
            soup: pool.filter(d=>d.type==="æ±¤å“"),
            main: pool.filter(d=>d.type==="ä¸»è¤"),
            side: pool.filter(d=>d.type==="è¾…è¤"),
            veg: pool.filter(d=>d.type==="ç´ èœ"),
            cold: pool.filter(d=>d.type==="å‡‰èœ"),
            oth: pool.filter(d=>["ä¸‹é¥­èœ","å°åƒ"].includes(d.type))
        };

        // ç®—æ³•å°è¯•300æ¬¡å–æœ€ä¼˜
        let final = null;
        let minDiff = 99999;

        for(let k=0; k<300; k++) {
            let m = [];
            let p = 0;
            let slots = totalD;
            let meat = 0;
            
            const pick = (arr) => {
                let v = arr.filter(x => !m.includes(x) && (!x.mutex || !m.some(ex => ex.mutex === x.mutex)));
                if(!v.length) return null;
                return shuffle(v)[0];
            };

            // A. æ±¤
            if(cats.soup.length) {
                let d = pick(cats.soup) || shuffle(cats.soup)[0];
                if(d) { m.push(d); p+=d.price; slots--; }
            }

            // B. ä¸»è¤ (æŒ‰æ¡Œå‹å¤§å°å†³å®šä»½é‡åå¥½)
            const mL = cats.main.filter(d=>d.size==='L');
            const mM = cats.main.filter(d=>d.size==='M');
            
            if(slots>0) {
                if(isMega) { // å¤§æ¡Œä¼˜å…ˆå¤§èœ
                    let d1 = pick(mL) || pick(cats.main);
                    if(d1) { m.push(d1); p+=d1.price; slots--; meat++; }
                    if(slots>0) { let d2 = pick(mM) || pick(cats.main); if(d2) { m.push(d2); p+=d2.price; slots--; meat++; } }
                } else {
                    let d = pick(mM) || pick(cats.main);
                    if(d) { m.push(d); p+=d.price; slots--; meat++; }
                }
            }

            // C. å¿…é€‰ç´ èœ
            if(slots>0 && cats.veg.length) {
                let d = pick(cats.veg);
                if(d) { m.push(d); p+=d.price; slots--; }
            }

            // D. å¡«å……å‰©ä½™
            let targetMeat = isSmall ? 3 : 4;
            while(slots>0) {
                let sub = [];
                if(meat < targetMeat) sub = [...cats.side, ...cats.main];
                else sub = [...cats.side, ...cats.oth, ...cats.veg, ...cats.cold];
                
                let d = pick(sub);
                if(!d) break;
                
                m.push(d); p+=d.price; slots--;
                if(d.type.includes("è¤")) meat++;
            }

            if(p <= limit) { final = {m, p}; break; } // é¢„ç®—å†…ç›´æ¥è¿”å›
            else if(p < minDiff) { minDiff = p; final = {m, p}; } // è®°å½•æœ€å°è¶…æ”¯
        }

        if(!final) { alert("ç”Ÿæˆå¤±è´¥ï¼Œèœå“åº“ä¸è¶³"); return; }
        best = final;
        render(final, num, tables, pPerT, limit);
    }

    function render(plan, total, t, ppt, limit) {
        document.getElementById('res').style.display = 'block';
        const ord = {"æ±¤å“":1,"ä¸»è¤":2,"è¾…è¤":3,"å‡‰èœ":4,"ä¸‹é¥­èœ":5,"ç´ èœ":6,"å°åƒ":7};
        plan.m.sort((a,b)=>(ord[a.type]||9)-(ord[b.type]||9));

        document.getElementById('sum').innerHTML = `<div>ğŸ‘¥ <strong>${total}äºº</strong> (${t}æ¡Œ) | é¢„ç®— Â¥${limit}</div>`;
        
        let h = `<table>`;
        plan.m.forEach(d => {
            let tag = d.size=='L'?'L':(d.size=='S'?'S':'');
            let tagHtml = tag ? `<span class="tag t-${tag}">${tag=='L'?'å¤§':'å°'}</span>` : '';
            h += `<tr><td><div style="color:#999;font-size:12px">${d.type}</div>${d.name}${tagHtml}</td><td class="price">Â¥${d.price}</td></tr>`;
        });
        h += `<tr style="border-top:2px solid #eee"><td style="font-weight:bold">åˆè®¡</td><td class="price" style="font-weight:bold">Â¥${plan.p.toFixed(1)}</td></tr></table>`;
        document.getElementById('list').innerHTML = h;
        
        let avg = (plan.p/ppt).toFixed(1);
        let budEl = document.getElementById('bud');
        budEl.innerHTML = plan.p<=limit ? `âœ… äººå‡ Â¥${avg} (é¢„ç®—å†…)` : `âš ï¸ äººå‡ Â¥${avg} (è¶…æ”¯)`;
        budEl.style.color = plan.p<=limit ? "#00b894" : "#ff7675";
    }

    function copyMenu() {
        if(!best) return;
        let t = best.m.map(d=>d.name).join('ã€');
        
        // è®°å½•å†å²
        hist.unshift({date:new Date().toLocaleDateString(), dishes:best.m.map(d=>d.name)});
        if(hist.length>5) hist = hist.slice(0,5);
        localStorage.setItem(HIST_KEY, JSON.stringify(hist));

        navigator.clipboard.writeText(t).then(()=>alert("å·²å¤åˆ¶ï¼"));
    }

    function clearHist() {
        if(confirm("è¦æ¸…ç©ºâ€˜å·²åƒè¿‡â€™çš„è®°å½•å—ï¼Ÿ")) {
            hist = [];
            localStorage.removeItem(HIST_KEY);
            alert("å†å²è®°å½•å·²æ¸…ç©º");
        }
    }

    init();
</script>
</body>
</html>
