<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç™¾å¹´ç¥å¨ Â· æ™ºèƒ½ç‚¹é¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- ç°ä»£æç®€è®¾è®¡ç³»ç»Ÿ (Final) --- */
        :root {
            --bg-body: #F5F7FA;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --accent: #10B981; /* æç®€ç»¿ */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        /* å¼¥æ•£èƒŒæ™¯å…‰ */
        .ambient-light {
            position: fixed;
            top: -20%; left: -20%;
            width: 140%; height: 80%;
            background: radial-gradient(circle, rgba(16, 185, 129, 0.06) 0%, rgba(255,255,255,0) 70%);
            z-index: -1;
            pointer-events: none;
        }

        /* å¡ç‰‡ç³»ç»Ÿ */
        .soft-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.03), 0 10px 15px -3px rgba(0, 0, 0, 0.01);
            border-radius: 24px;
        }

        /* è¾“å…¥æ¡† */
        .modern-input {
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 18px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modern-input:focus-within {
            background: #FFFFFF;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
            transform: translateY(-1px);
        }

        /* æŒ‰é’®åŠ¨æ•ˆ */
        .btn-press { transition: all 0.15s ease; }
        .btn-press:active { transform: scale(0.96); }
        
        /* åŠ¨ç”» */
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { 
            animation: slideUpFade 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; 
            opacity: 0;
        }

        .tag-budget { font-variant-numeric: tabular-nums; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-5 pb-32 flex flex-col max-w-md mx-auto relative">

    <div class="ambient-light"></div>

    <!-- é¡¶éƒ¨å¯¼èˆªæ  (æ–°å¢ï¼šè¿”å›ä¸»é¡µ) -->
    <div class="flex justify-between items-center mt-4 mb-6">
        <button onclick="location.href='../index.html'" class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm border border-gray-100 text-lg text-gray-600 hover:bg-gray-50 active:scale-90 transition" aria-label="è¿”å›ä¸»é¡µ">
            ğŸ 
        </button>
        <div id="status-badge" class="px-3 py-1 rounded-full bg-white/50 border border-gray-200 text-gray-400 text-xs font-medium backdrop-blur-sm">
            Connecting...
        </div>
    </div>

    <!-- æ ‡é¢˜åŒºåŸŸ -->
    <div class="mb-8 px-1">
        <div class="text-[10px] font-bold text-emerald-600 uppercase tracking-widest mb-1.5 opacity-80">Smart Dining Assistant</div>
        <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">ç™¾å¹´ç¥å¨</h1>
    </div>

    <!-- ä¸»è¦æ“ä½œåŒº -->
    <div class="soft-card p-6 mb-8">
        <div class="flex justify-between items-baseline mb-4">
            <label class="text-sm font-semibold text-gray-600">ç”¨é¤äººæ•°</label>
            <!-- é¢„ç®—æ ‡ç­¾ -->
            <span class="text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-lg border border-emerald-100">
                ç›®æ ‡: Â¥29-33 (Max 35)
            </span>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="modern-input flex-1 h-16 flex items-center px-5 group">
                <span class="text-2xl mr-3 opacity-50 group-focus-within:opacity-100 transition-opacity">ğŸ‘¥</span>
                <input type="number" id="pCount" value="10" class="w-full bg-transparent outline-none text-2xl font-bold text-gray-800 placeholder-gray-300" placeholder="10">
            </div>
            <button id="genBtn" onclick="generate()" disabled class="btn-press h-16 w-16 rounded-2xl bg-emerald-500 text-white flex items-center justify-center shadow-xl shadow-emerald-200/50 disabled:opacity-50 disabled:shadow-none disabled:bg-gray-300 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                </svg>
            </button>
        </div>
    </div>

    <!-- ç»“æœå±•ç¤ºåŒº -->
    <div id="result-area" class="hidden">
        
        <!-- æ•°æ®æ¦‚è§ˆ -->
        <div class="grid grid-cols-2 gap-4 mb-6 animate-enter" style="animation-delay: 0ms">
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100/50 flex flex-col justify-between h-24">
                <div class="text-xs text-gray-400 font-bold uppercase tracking-wide">æ€»é¢„ç®—</div>
                <div class="text-2xl font-bold text-gray-900 tag-budget" id="res-total">Â¥0</div>
            </div>
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100/50 flex flex-col justify-between h-24 relative overflow-hidden">
                <div class="absolute right-0 top-0 w-16 h-16 bg-current opacity-5 rounded-full -mr-4 -mt-4" id="res-bg-blob"></div>
                <div class="text-xs text-gray-400 font-bold uppercase tracking-wide">äººå‡ (ç›®æ ‡ 29-33)</div>
                <div class="text-2xl font-bold tag-budget flex items-baseline gap-1" id="res-avg-container">
                    <span id="res-avg">Â¥0</span>
                </div>
            </div>
        </div>

        <!-- èœå•åˆ—è¡¨ -->
        <div class="soft-card p-1 animate-enter" style="animation-delay: 100ms">
            <div class="px-5 py-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-bold text-gray-800">Menu</h3>
                <div class="flex gap-2">
                    <button onclick="copyMenu()" class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded-lg font-bold hover:bg-emerald-100 transition-colors flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                        ä»…å¤åˆ¶èœå
                    </button>
                </div>
            </div>
            
            <div id="menu-list" class="divide-y divide-gray-50"></div>
        </div>
    </div>

    <!-- å†å²è®°å½•å¡ç‰‡ -->
    <div id="history-section" class="hidden mt-8 mb-8 animate-enter" style="animation-delay: 200ms">
        <div class="flex items-center justify-between mb-3 px-2">
            <div class="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-1">
                <span>å†å²è®¢å• / å·²å±è”½</span>
                <span id="hist-count" class="bg-gray-200 text-gray-500 px-1.5 rounded text-[10px]">0</span>
            </div>
            <button onclick="clearHist()" class="text-xs text-red-400 hover:text-red-600 font-medium flex items-center gap-1 px-2 py-1 rounded hover:bg-red-50 transition">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                æ¸…ç©º
            </button>
        </div>
        <div class="soft-card p-4">
            <div id="hist-timeline" class="space-y-4">
                <!-- å†å²è®°å½•åˆ—è¡¨å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
            </div>
            <p id="hist-empty" class="text-center text-xs text-gray-300 py-2">æš‚æ— å†å²è®°å½•</p>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-gray-900/90 backdrop-blur text-white px-6 py-3 rounded-full text-sm font-medium shadow-xl transition-all duration-300 opacity-0 -translate-y-4 pointer-events-none z-50 flex items-center gap-2">
        <svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
        <span id="toast-msg">æ“ä½œæˆåŠŸ</span>
    </div>

<script>
    /* ================= æ ¸å¿ƒé€»è¾‘ ================= */
    let db = [];
    let hist = [];
    let best = null;
    const HIST_KEY = 'sz_hist_v10';

    async function init() {
        try {
            const res = await fetch('dishes.json?t=' + new Date().getTime());
            if(!res.ok) throw new Error("Load Failed");
            const raw = await res.json();
            
            db = raw.map(d => ({
                ...d, 
                size: d.size || autoSize(d.name), 
                mutex: d.mutex || ""
            }));

            loadHist();

            const badge = document.getElementById('status-badge');
            badge.textContent = "Online";
            badge.className = "px-3 py-1 rounded-full bg-emerald-50 text-emerald-600 text-xs font-medium border border-emerald-100";
            document.getElementById('genBtn').disabled = false;
        } catch(e) {
            const badge = document.getElementById('status-badge');
            badge.textContent = "Offline";
            badge.className = "px-3 py-1 rounded-full bg-red-50 text-red-500 text-xs font-medium";
        }
    }

    function loadHist() {
        const h = localStorage.getItem(HIST_KEY);
        hist = h ? JSON.parse(h) : [];
        renderHist();
    }

    function formatDate(ts) {
        if(!ts) return '';
        const date = new Date(ts);
        const m = date.getMonth() + 1;
        const d = date.getDate();
        const week = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'][date.getDay()];
        return `${m}æœˆ${d}æ—¥ ${week}`;
    }

    function renderHist() {
        const section = document.getElementById('history-section');
        const timelineEl = document.getElementById('hist-timeline');
        const emptyEl = document.getElementById('hist-empty');
        const countEl = document.getElementById('hist-count');

        // æå–æ‰€æœ‰è¢«å±è”½çš„èœåæ•°é‡
        const bannedDishes = new Set();
        hist.forEach(h => h.dishes.forEach(d => bannedDishes.add(d)));
        
        section.classList.remove('hidden');
        countEl.textContent = bannedDishes.size;

        if(hist.length === 0) {
            timelineEl.innerHTML = '';
            emptyEl.style.display = 'block';
        } else {
            emptyEl.style.display = 'none';
            timelineEl.innerHTML = hist.map((entry, index) => {
                // å…¼å®¹æ—§æ•°æ®ï¼ˆå¦‚æœæ²¡æœ‰ timestampï¼Œå°è¯•ç”¨ date å­—ç¬¦ä¸²ï¼‰
                const dateDisplay = entry.timestamp ? formatDate(entry.timestamp) : (entry.date || 'æœªçŸ¥æ—¥æœŸ');
                
                return `
                <div class="border-l-2 border-emerald-100 pl-4 py-1 relative">
                    <div class="absolute -left-[5px] top-2 w-2.5 h-2.5 rounded-full bg-emerald-200 border-2 border-white"></div>
                    <div class="text-xs text-gray-400 font-medium mb-1.5">${dateDisplay}</div>
                    <div class="flex flex-wrap gap-1.5">
                        ${entry.dishes.map(d => `
                            <span class="px-2 py-0.5 bg-gray-50 rounded text-[11px] text-gray-600 border border-gray-100">${d}</span>
                        `).join('')}
                    </div>
                </div>
                `;
            }).join('');
        }
    }

    function autoSize(n) {
        if(n.includes("å…¨å®¶ç¦")) return 'L';
        if(n.includes("å°ä»½")||n.includes("ä¸€æ¡")) return 'S';
        if((n.includes("é±¼")||n.includes("é¸¡")||n.includes("å…”")||n.includes("è›™")||n.includes("é¸­")) && !n.includes("ç‰‡") && !n.includes("ä¸") && !n.includes("ä¸")) return 'L';
        return 'M';
    }

    function shuffle(a) { return a.sort(()=>Math.random()-0.5); }

    function generate() {
        const num = parseInt(document.getElementById('pCount').value);
        if(num<2) { showToast("è‡³å°‘2äººç”¨é¤"); return; }

        const tables = Math.ceil(num/11);
        const pPerT = Math.ceil(num/tables);
        
        // --- é¢„ç®—æ ¸å¿ƒé€»è¾‘ ---
        const limitMax = pPerT * 35;      // ç»å¯¹çº¢çº¿ (35)
        const limitIdealMin = pPerT * 29; // ç†æƒ³ä¸‹é™ (29)
        const limitIdealMax = pPerT * 33; // ç†æƒ³ä¸Šé™ (33)
        
        const totalD = Math.max(2, pPerT - 1); 

        // è¿‡æ»¤å†å²
        const ban = new Set();
        hist.forEach(h => h.dishes.forEach(d => ban.add(d)));
        let pool = db.filter(d => !ban.has(d.name));
        if(pool.length < 10) pool = db; // èœä¸å¤Ÿæ—¶å¿½ç•¥å†å²

        const cats = {
            soup: pool.filter(d=>d.type==="æ±¤å“"),
            main: pool.filter(d=>d.type==="ä¸»è¤"),
            side: pool.filter(d=>d.type==="è¾…è¤"),
            veg: pool.filter(d=>d.type==="ç´ èœ"),
            cold: pool.filter(d=>d.type==="å‡‰èœ"),
            oth: pool.filter(d=>["ä¸‹é¥­èœ","å°åƒ"].includes(d.type))
        };

        let final = null;
        let bestDiff = 99999; // è·ç¦»ç†æƒ³åŒºé—´ä¸­å¿ƒçš„å·®è·

        // å°è¯• 500 æ¬¡
        for(let k=0; k<500; k++) {
            let m = [];
            let p = 0;
            let slots = totalD;
            let smallCount = 0; 

            const pick = (arr) => {
                let v = arr.filter(x => {
                    if (m.includes(x)) return false;
                    if (x.mutex && m.some(ex => ex.mutex === x.mutex)) return false;
                    if (x.size === 'S' && smallCount >= 1) return false;
                    return true;
                });
                if(!v.length) return null;
                return shuffle(v)[0];
            };

            const addDish = (d) => {
                if(d) { m.push(d); p += d.price; slots--; if(d.size === 'S') smallCount++; }
            };

            // å¿…é€‰æµç¨‹: æ±¤ -> ä¸»è¤ -> ç´ 
            if(cats.soup.length) addDish(pick(cats.soup));
            if(slots > 0) {
                const mL = cats.main.filter(d=>d.size==='L');
                const mM = cats.main.filter(d=>d.size==='M');
                let d1 = pick(mL) || pick(mM) || pick(cats.main);
                addDish(d1);
            }
            if(slots > 0 && cats.veg.length) addDish(pick(cats.veg));

            // å¡«å……å‰©ä½™
            let meatCount = m.filter(d=>d.type.includes('è¤')).length;
            let targetMeat = (pPerT < 7) ? 3 : 4;

            while(slots > 0) {
                let sub = [];
                if(meatCount < targetMeat) sub = [...cats.side, ...cats.main];
                else sub = [...cats.side, ...cats.oth, ...cats.veg, ...cats.cold];
                let d = pick(sub); if(!d) break;
                addDish(d);
                if(d.type.includes('è¤')) meatCount++;
            }

            // --- è¯„åˆ†é€»è¾‘æ›´æ–° ---
            if (p > limitMax) continue;

            let diff = 0;
            if (p >= limitIdealMin && p <= limitIdealMax) {
                diff = 0; // å®Œç¾
            } else if (p < limitIdealMin) {
                diff = limitIdealMin - p;
            } else {
                diff = p - limitIdealMax;
            }

            if (diff < bestDiff) {
                bestDiff = diff;
                final = {m, p};
                if (diff === 0) break;
            }
        }

        if(!final) { showToast("é¢„ç®—å¤ªç´§ï¼Œå°è¯•å¢åŠ äººæ•°æˆ–é¢„ç®—"); return; }
        best = final;
        render(final, num, tables, pPerT, limitIdealMax, limitMax);
    }

    function render(plan, total, t, ppt, limitIdeal, limitMax) {
        document.getElementById('result-area').classList.remove('hidden');
        
        const ord = {"æ±¤å“":1,"ä¸»è¤":2,"è¾…è¤":3,"å‡‰èœ":4,"ä¸‹é¥­èœ":5,"ç´ èœ":6,"å°åƒ":7};
        plan.m.sort((a,b)=>(ord[a.type]||9)-(ord[b.type]||9));

        const listEl = document.getElementById('menu-list');
        listEl.innerHTML = plan.m.map((d, i) => {
            let tag = '';
            if(d.size === 'L') tag = `<span class="ml-2 px-1.5 py-0.5 rounded text-[10px] font-bold bg-orange-100 text-orange-600">å¤§</span>`;
            else if(d.size === 'S') tag = `<span class="ml-2 px-1.5 py-0.5 rounded text-[10px] font-bold bg-blue-50 text-blue-500">å°</span>`;
            
            return `
                <div class="p-4 flex justify-between items-center hover:bg-gray-50 transition-colors">
                    <div class="flex items-start gap-3">
                        <div class="text-sm font-bold text-gray-400 w-6 pt-1">0${i+1}</div>
                        <div>
                            <div class="text-gray-900 font-medium flex items-center">
                                ${d.name} ${tag}
                            </div>
                            <div class="text-xs text-gray-400 mt-0.5">${d.type}</div>
                        </div>
                    </div>
                    <div class="text-gray-900 font-semibold">Â¥${d.price}</div>
                </div>
            `;
        }).join('');

        document.getElementById('res-total').innerText = `Â¥${plan.p.toFixed(0)}`;
        
        let avg = (plan.p/ppt).toFixed(0);
        let avgEl = document.getElementById('res-avg');
        let iconEl = document.getElementById('res-status-icon');
        let box = document.getElementById('res-bg-blob');
        
        avgEl.innerText = `Â¥${avg}`;
        
        // è§†è§‰åé¦ˆ
        if(plan.p <= limitIdeal) {
            // å®Œç¾åŒºé—´ (<=33)
            avgEl.className = "text-emerald-600";
            box.className = "absolute right-0 top-0 w-16 h-16 bg-emerald-500 opacity-10 rounded-full -mr-4 -mt-4";
            document.getElementById('res-avg-container').className = "text-2xl font-bold tag-budget flex items-baseline gap-1 text-emerald-600";
        } else {
            // ç¨å¾®æœ‰ç‚¹è´µ (33-35)
            avgEl.className = "text-orange-500";
            box.className = "absolute right-0 top-0 w-16 h-16 bg-orange-500 opacity-10 rounded-full -mr-4 -mt-4";
            document.getElementById('res-avg-container').className = "text-2xl font-bold tag-budget flex items-baseline gap-1 text-orange-500";
        }
        
        document.getElementById('res-count').innerText = `${plan.m.length} é“èœ`;
        
        setTimeout(() => {
            document.getElementById('result-area').scrollIntoView({behavior: 'smooth', block: 'start'});
        }, 100);
    }

    function copyMenu() {
        if(!best) return;
        
        // 1. çº¯å‡€å¤åˆ¶é€»è¾‘
        const text = best.m.map(d => d.name).join('ã€');

        // 2. å­˜å…¥å†å² (åŒ…å«æ—¶é—´æˆ³)
        const now = new Date();
        hist.unshift({
            timestamp: now.getTime(),
            date: now.toLocaleDateString(), 
            dishes: best.m.map(d=>d.name)
        });
        if(hist.length>5) hist = hist.slice(0,5);
        localStorage.setItem(HIST_KEY, JSON.stringify(hist));
        
        // 3. åˆ·æ–°å†å²å¡ç‰‡
        renderHist();

        navigator.clipboard.writeText(text).then(() => showToast("èœåå·²å¤åˆ¶"));
    }

    function clearHist() {
        if(confirm("æ¸…é™¤æ‰€æœ‰â€œå·²åƒè¿‡â€çš„è®°å½•ï¼Ÿ")) {
            hist = [];
            localStorage.removeItem(HIST_KEY);
            renderHist();
            showToast("å†å²è®°å½•å·²æ¸…ç©º");
        }
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        const txt = document.getElementById('toast-msg');
        txt.innerText = msg;
        t.classList.remove('opacity-0', '-translate-y-4');
        setTimeout(() => t.classList.add('opacity-0', '-translate-y-4'), 2000);
    }

    init();
</script>
</body>
</html>
